<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>The Ale Tavern</title>

        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <style>
         body { padding-top:50px; }
        </style>

    </head>

    <body>

        <div class="container">
            <div class="jumbotron text-center">
                <h1>Future of Ale Tavern</h1>
		            <h3>A place to play games with friends, in person.</h3>
            </div>
        </div>

        <div class="container">
            <div class="jumbotron text-center">
                <h4 id="rMessage"></h4>

                <input id="sMessage" type="text" autocomplete="off">
                <input id="sendMessageToAll"type="button" name="submit" value="sendMessageToAll()" onclick="sendMessageToAll();" />
                <input id="sendMessageToHost"type="button" name="submit" value="sendMessageToHost()" onclick="sendMessageToHost();" />
                <input id="joinGame"type="button" name="submit" value="joinGame()" onclick="joinGame();" />
                <input id="createGame"type="button" name="submit" value="createGame()" onclick="createGame();" />
                <input id="reconnectGame"type="button" name="submit" value="reconnectGame()" onclick="reconnectGame();" />
                <input id="leaveGame"type="button" name="submit" value="leaveGame()" onclick="leaveGame();" />
            </div>
        </div>

        <div class="container">
            <ul id ="messages"></ul>
        </div>



        <script>


         // ***************************************************************************************************
         // ********************** Frontend GameWebSocket Api *************************************************
         // ***************************************************************************************************
         class GameWebSocket { // TODO make sure websocket is still alive!

             constructor(logging = false){
                 var wsPath = "ws://" +  window.location.host + "/game";
                 this.ws = new WebSocket(wsPath);
                 this.ws.addEventListener('message', this.messageHandler.bind(this));
                 this.logging = logging;
             }

             messageHandler(event){

                 var msgObj = JSON.parse(event.data);

                 if(logging){console.log(msgObj);}

                 // TODO Add all other types. OTHERJOINGAME etc. 
                 if(msgObj.type == "CREATEGAME") // TODO probably make a switch...
                 {
                     this.gameId = msgObj.data;
                     sessionStorage.setItem("gameId", this.gameId);
                     sessionStorage.setItem("playerId", msgObj.playerId);

                     if(this.onCreateGame){this.onCreateGame(msgObj)};

                 }
                 if(msgObj.type == "JOINGAME")
                 {
                     this.gameId = msgObj.data.gameId;
                     this.playerId = msgObj.playerId;
                     this.hostId = msgObj.hostId;

                     sessionStorage.setItem("gameId", this.gameId);
                     sessionStorage.setItem("playerId", msgObj.playerId);
                     sessionStorage.setItem("hostId", msgObj.hostId);

                     if(this.onJoinGame){this.onJoinGame(msgObj)};
                 }

                 if(msgObj.type == "OTHERJOINGAME")
                 {
                     if(this.onOtherJoinGame){this.onOtherJoinGame(msgObj);}
                 }

                 if(msgObj.type == "OTHERLEAVEGAME")
                 {
                     if(this.onOtherLeaveGame){this.onOtherLeaveGame(msgObj);}
                 }

                 if(msgObj.type == "MESSAGEGAME")
                 {
                     if(this.onMessageGame){this.onMessageGame(msgObj)};
                 }

                 if(msgObj.type == "LEAVEGAME")
                 {
                     this.clearData();
                     if(this.onLeaveGame){this.onJoinGame(msgObj)};
                 }

                 if(msgObj.type == "RECONNECTGAME")
                 {
                     this.gameId = msgObj.data.gameId;
                     this.playerId = msgObj.playerId;
                     this.hostId = msgObj.hostId;

                     sessionStorage.setItem("gameId", this.gameId);
                     sessionStorage.setItem("playerId", msgObj.playerId);
                     sessionStorage.setItem("hostId", msgObj.hostId);

                     if(this.onReconnectGame){this.onJoinGame(msgObj)};
                 }

             }

             clearData()
             {
                 this.gameId = undefined;
                 this.playerId = undefined;
                 this.hostId = undefined;

                 sessionStorage.clear(); // just clear everything
             }

             loadData()
             {
                 this.gameId = sessionStorage.getItem("gameId");
                 this.playerId = sessionStorage.getItem("playerId");
                 this.hostId = sessionStorage.getItem("hostId");

                 sessionStorage.clear(); // just clear everything
             }

             createGame(){
                 var createMessageObj = {type:"CREATEGAME"};
                 this.ws.send(JSON.stringify(createMessageObj));
             }

             joinGame(gameId){
                 var joinMessageObj = {type:"JOINGAME", data:gameId};
                 this.ws.send(JSON.stringify(joinMessageObj));
             }

             sendMessageToAll(msg){
                 var sendMessageObj = {type:"MESSAGEALLGAME", playerId:sessionStorage.getItem("playerId"), data:msg}
                 this.ws.send(JSON.stringify(sendMessageObj));
             }

             sendMessageToHost(msg){
                 var sendMessageObj = {type:"MESSAGEHOSTGAME", playerId:sessionStorage.getItem("playerId"), data:msg}
                 this.ws.send(JSON.stringify(sendMessageObj));
             }

             sendMessageToOne(receiverId, msg){
                 var addressedMessage = {receiverId:receiverId, data:msg};
                 var sendMessageObj = {type:"MESSAGEONEGAME", playerId:sessionStorage.getItem("playerId"), data:addressedMessage};
                 this.ws.send(JSON.stringify(sendMessageObj)); // Add try catch. Reconnect on catch
             }

             reconnectGame()
             {
                 this.loadData();

                 if(this.playerId) // always use session storage or load data?
                 {
                     var sendMessageObj = {type:"RECONNECTGAME", playerId:this.playerId};
                     this.ws.send(JSON.stringify(sendMessageObj)); // TODO refactor stringify
                 }
             }

             leaveGame()
             {
                 var sendMessageObj = {type:"LEAVEGAME", playerId:sessionStorage.getItem("playerId")}
                 this.ws.send(JSON.stringify(sendMessageObj)); // TODO refactor stringify
             }
         }

         // ***************************************************************************************************
         // ***************************************************************************************************
         // ***************************************************************************************************

         var input = document.getElementById("sMessage");
         var output = document.getElementById("messages");

         var gameWebSocket = new GameWebSocket(logging=true);


         // ***************** Event listeners **********************************
         // Pressing enter will default to "sendMessage()"
         input.addEventListener("keydown", function(event){
             if (event.keyCode === 13)
             {
                 event.preventDefault();
                 document.getElementById("sendMessageToAll").click();
             }
         });

         // Listen for messages


         // ********************* BUTTON FUNCTIONS *******************************

         function createGame(){
             gameWebSocket.createGame();
         }

         function joinGame(){
             gameWebSocket.joinGame(getAndClearInput());
         }

         function sendMessageToAll(msg){
             gameWebSocket.sendMessageToAll(getAndClearInput());
         }

         function sendMessageToHost(msg){
             gameWebSocket.sendMessageToHost(getAndClearInput());
         }

         function reconnectGame(){
             gameWebSocket.reconnectGame();
         }

         function leaveGame(){
             gameWebSocket.leaveGame();
         }

         // *********************** ON EVENT FUNCTIONS *************************

         gameWebSocket.onCreateGame = (msg) => {let text = "Game created with ID: " + msg.data; addToChat(text)};
         gameWebSocket.onMessageGame = (msg) => { addToChat(msg.playerId + " sent: " + msg.data)};
         gameWebSocket.onOtherJoinGame = (msg) => { addToChat(msg.playerId + " joined the game.")};
         gameWebSocket.onOtherLeaveGame = (msg) => { addToChat(msg.playerId + " left the game.")};


         // ******************* HELPER FUNCTIONS *******************************
         function getAndClearInput(){
             var val = input.value;
             input.value = "";
             return val;
         }

         function addToChat(text)
         {
             let entry = document.createElement("LI");
             entry.innerHTML = text;
             output.insertBefore(entry, output.firstChild);
         }

        </script>

    </body>
</html>

