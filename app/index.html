<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>The Ale Tavern</title>

        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
        <style>
         body { padding-top:50px; }
        </style>

    </head>

    <body>

        <div class="container">
            <div class="jumbotron text-center">
                <h1>Future of Ale Tavern</h1>
		            <h3>A place to play games with friends, in person.</h3>
            </div>
        </div>

        <div class="container">
            <div class="jumbotron text-center">
                <h4 id="rMessage"></h4>

                <input id="sMessage" type="text" autocomplete="off">
                <input id="sendMessageToAll"type="button" name="submit" value="sendMessageToAll()" onclick="sendMessageToAll();" />
                <input id="sendMessageToHost"type="button" name="submit" value="sendMessageToHost()" onclick="sendMessageToHost();" />
                <input id="joinGame"type="button" name="submit" value="joinGame()" onclick="joinGame();" />
                <input id="createGame"type="button" name="submit" value="createGame()" onclick="createGame();" />
            </div>
        </div>

        <div class="container">
            <ul id ="messages"></ul>
        </div>


        <script>


         // ***************************************************************************************************
         // ********************** Frontend GameWebSocket Api *************************************************
         // ***************************************************************************************************
         class GameWebSocket {

             constructor(logging = false){
                 var wsPath = "ws://" +  window.location.host + "/game";
                 this.ws = new WebSocket(wsPath);
                 this.ws.addEventListener('message', this.newMessageHandler.bind(this));
                 this.logging = logging;
             }

             newMessageHandler(event){

                 var msgObj = JSON.parse(event.data);

                 if(logging){console.log(msgObj);}

                 if(msgObj.type == "CREATEGAME")
                 {
                     this.gameId = msgObj.data;
                     sessionStorage.setItem("currentGameId", this.gameId);
                     sessionStorage.setItem("playerId", msgObj.playerId); // Consider using session storage

                     if(this.onCreateGame){this.onCreateGame(msgObj)};

                 }
                 if(msgObj.type == "JOINGAME")
                 {
                     this.gameId = msgObj.data
                     sessionStorage.setItem("currentGameId", this.gameId);
                     sessionStorage.setItem("playerId", msgObj.playerId); // Consider using session storage

                     if(this.onJoinGame){this.onJoinGame(msgObj)};
                 }

                 if(msgObj.type == "MESSAGEGAME")
                 {
                     if(this.onGameMessage){this.onMessageGame(msgObj)};
                 }
             }

             createGame(){
                 var createMessageObj = {type:"CREATEGAME"};
                 this.ws.send(JSON.stringify(createMessageObj));
             }

             joinGame(gameId){
                 var joinMessageObj = {type:"JOINGAME", data:gameId};
                 this.ws.send(JSON.stringify(joinMessageObj));
             }

             sendMessageToAll(msg){
                 var sendMessageObj = {type:"MESSAGEALLGAME", playerId:sessionStorage.getItem("playerId"), data:msg}
                 this.ws.send(JSON.stringify(sendMessageObj));
             }

             sendMessageToHost(msg){
                 var sendMessageObj = {type:"MESSAGEHOSTGAME", playerId:sessionStorage.getItem("playerId"), data:msg}
                 this.ws.send(JSON.stringify(sendMessageObj));
             }
         }

         // ***************************************************************************************************
         // ***************************************************************************************************
         // ***************************************************************************************************

         var input = document.getElementById("sMessage");
         var output = document.getElementById("messages");

         var gameWebSocket = new GameWebSocket(logging=true);


         // ***************** Event listeners **********************************
         // Pressing enter will default to "sendMessage()"
         input.addEventListener("keydown", function(event){
             if (event.keyCode === 13)
             {
                 event.preventDefault();
                 document.getElementById("sendMessageToAll").click();
             }
         });

         // Listen for messages


         // ********************* BUTTON FUNCTIONS *******************************

         function createGame(){
             gameWebSocket.createGame();
         }

         function joinGame(){
             gameWebSocket.joinGame(getAndClearInput());
         }

         function sendMessageToAll(msg){
             gameWebSocket.sendMessageToAll(getAndClearInput());
         }

         function sendMessageToHost(msg){
             gameWebSocket.sendMessageToHost(getAndClearInput());
         }

         gameWebSocket.onCreateGame = () => console.log("WE IN BOIS");

         // ******************* HELPER FUNCTIONS *******************************
         function getAndClearInput(){
             var val = input.value;
             input.value = "";
             return val;
         }

        </script>

    </body>
</html>

